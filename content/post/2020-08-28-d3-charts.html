---
title: "Test"
---



<iframe src="https://liuyanguu.shinyapps.io/bcl_app/" width="1000" height="800&quot;">
</iframe>
<pre class="r"><code># based on the excellent example on https://deanattali.com/blog/building-shiny-apps-tutorial/

library(shiny)</code></pre>
<pre><code>## Warning: package &#39;shiny&#39; was built under R version 3.6.3</code></pre>
<pre class="r"><code>library(ggplot2)
library(data.table)</code></pre>
<pre><code>## Warning: package &#39;data.table&#39; was built under R version 3.6.3</code></pre>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## Warning: package &#39;tidyverse&#39; was built under R version 3.6.3</code></pre>
<pre><code>## -- Attaching packages ----------------------------------------------------------------------------------------------------------------- tidyverse 1.3.0 --</code></pre>
<pre><code>## v tibble  2.1.3     v dplyr   0.8.5
## v tidyr   1.0.2     v stringr 1.4.0
## v readr   1.3.1     v forcats 0.5.0
## v purrr   0.3.3</code></pre>
<pre><code>## Warning: package &#39;tidyr&#39; was built under R version 3.6.3</code></pre>
<pre><code>## Warning: package &#39;dplyr&#39; was built under R version 3.6.3</code></pre>
<pre><code>## Warning: package &#39;forcats&#39; was built under R version 3.6.3</code></pre>
<pre><code>## -- Conflicts -------------------------------------------------------------------------------------------------------------------- tidyverse_conflicts() --
## x dplyr::between()   masks data.table::between()
## x dplyr::filter()    masks stats::filter()
## x dplyr::first()     masks data.table::first()
## x dplyr::lag()       masks stats::lag()
## x dplyr::last()      masks data.table::last()
## x purrr::transpose() masks data.table::transpose()</code></pre>
<pre class="r"><code>library(DT) # for `renderDataTable`</code></pre>
<pre><code>## Warning: package &#39;DT&#39; was built under R version 3.6.3</code></pre>
<pre><code>## 
## Attaching package: &#39;DT&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:shiny&#39;:
## 
##     dataTableOutput, renderDataTable</code></pre>
<pre class="r"><code># The data are put in a local folder named `Data`
bcl &lt;- setDT(read_csv(&#39;https://raw.githubusercontent.com/liuyanguu/shiny_app_wine/master/Data/bcl-data.csv&#39;))</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   Type = col_character(),
##   Subtype = col_character(),
##   Country = col_character(),
##   Name = col_character(),
##   Alcohol_Content = col_double(),
##   Price = col_double(),
##   Sweetness = col_double()
## )</code></pre>
<pre class="r"><code>ui &lt;- fluidPage(
  titlePanel(&quot;Shiny Example: Liquor Store Selection&quot;),
  
# sidebarLayout  
  sidebarLayout(
    # side panel
        sidebarPanel(
    # price, type, and country 
          sliderInput(inputId = &quot;price_input&quot;, label = &quot;Price&quot;, min = 0, max = 100,
                      value = c(0, 50), pre = &quot;$&quot;),
          checkboxGroupInput(&quot;type_input&quot;, &quot;Product Type&quot;,
                       choices = c(&quot;BEER&quot;, &quot;REFRESHMENT&quot;, &quot;SPIRITS&quot;, &quot;WINE&quot;),
                       selected = c(&quot;BEER&quot;,&quot;WINE&quot;)),
          
          # a conditional panel to select sweetness 
          conditionalPanel(
            condition = &quot;input.type_input.indexOf(&#39;WINE&#39;)!=-1&quot;,
            p(&quot;Filter by sweetness if wine is selected:&quot;),
            sliderInput(inputId = &quot;sweet_input&quot;, label = &quot;Sweetness Level&quot;, min = 0, max = 10,
                        value = c(0, 5))
          ),
          
          checkboxInput(&quot;sort_by_price&quot;, &quot;Sort results table by price&quot;, value = TRUE),
          checkboxInput(&quot;show_country&quot;, &quot;Filter by country&quot;, value = FALSE),
          # populate the country selection
          conditionalPanel(
            condition = &quot;input.show_country&quot;,
            p(&quot;Available selection from these countries:&quot;),
            uiOutput(&quot;country_output&quot;)
            )
          ),
    
    # main panel for contents
        mainPanel(
            tabsetPanel(
              tabPanel(&quot;Results Table&quot;,
                      h3(textOutput(&quot;text_summary&quot;)), # add a headline of short summary
                      downloadLink(&#39;download_data&#39;, &#39;Download&#39;), # add download option   
                      br(),br(),
                      plotOutput(&quot;myplot0&quot;),
                      DT::dataTableOutput(&quot;results_table&quot;)),
              tabPanel(&quot;Alcohol%&quot;, plotOutput(&quot;myplot1&quot;)),
              tabPanel(&quot;Sweetness&quot;, plotOutput(&quot;myplot2&quot;)) 
            )
          )
    )
)

server &lt;- function(input, output) {
  # use a reactive function to screen for available countries to be shown in list
  # the input would be `country_input`
  output$country_output &lt;- renderUI({
    selectInput(&quot;country_input&quot;, &quot;Country&quot;,
                select.country(), # only show available countries from list
                selected = &quot;CANADA&quot;)
  })
  
  # the select.country function to return the list of `Country`
  select.country &lt;- reactive({
    # : 
    bcl_temp &lt;- bcl[Price &gt;= input$price_input[1]&amp;
          Price &lt;= input$price_input[2]&amp;
          Type %in% input$type_input,]
    if (!is.null(input$sweet_input)) bcl_temp &lt;- bcl_temp[Sweetness &gt;= input$sweet_input[1]&amp;
                                                            Sweetness &lt;= input$sweet_input[2]]
    bcl_temp[, sort(unique(Country))]
  })
  
  # subset the dataset
  filtered &lt;- reactive({
    bcl_temp &lt;- bcl[Price &gt;= input$price_input[1]&amp;
                 Price &lt;= input$price_input[2]&amp;
                 Type %in% input$type_input]
    if (input$show_country) bcl_temp &lt;- bcl_temp[Country %in% input$country_input]
    if (!is.null(input$sweet_input)) bcl_temp &lt;- bcl_temp[Sweetness &gt;= input$sweet_input[1]&amp;
                                                            Sweetness &lt;= input$sweet_input[2]]
    if (input$sort_by_price) bcl_temp[order(Price),] 
    else bcl_temp[order(Country),]
  })
  
  # Add text: &quot;There are in total # selections:&quot;
  output$text_summary &lt;- renderText({
    paste(&quot;There are in total&quot;, filtered()[,.N], &quot;options:&quot;)
  })
  
  # The data table
  output$results_table &lt;- DT::renderDataTable({
    filtered()
  })
  
  # Download buttom
  output$download_data &lt;- downloadHandler(
    filename = function() {
      paste(&#39;BCL_Data_Selection&#39;, Sys.Date(), &#39;.csv&#39;, sep=&quot;&quot;)
    },
    content = function(file) {
      write.csv(filtered(), file, row.names = F)
    }
  )
  
  # Figures
  ## fig.1 summary of price above results table
  output$myplot0 &lt;- renderPlot({
      if (is.null(filtered())){
        return()
      }
        ggplot(filtered(), aes(x = Price, fill = Type)) +
        geom_histogram(alpha = 0.7, aes(y = ..density..), position = &#39;identity&#39;) + 
        theme_bw() + 
        scale_fill_viridis_d(begin = 1, end = 0)+
        ggtitle(&quot;Distribution of Price in the Selection&quot;) + 
        labs(y = &quot;Frequency&quot;)
    })
  
   
  ## fig.1 Alcohol Content
  output$myplot1 &lt;- renderPlot({
    if (is.null(filtered())){
      return()
    }
    ggplot(filtered(), aes(x = Alcohol_Content, fill = Type)) +
      geom_histogram(alpha = 0.7, aes(y = ..density..), position = &#39;identity&#39;) + 
      theme_bw() + 
      scale_fill_viridis_d(begin = 1, end = 0)+
      ggtitle(&quot;Distribution of Alcohol Content in the Selection&quot;) + 
      labs(y = &quot;Count&quot;)
  })
  
  ## fig.2 Sweetness 
  output$myplot2 &lt;- renderPlot({
    if (is.null(filtered())){
      return()
    }
    ggplot(filtered(), aes(x = Sweetness, fill = Type)) +
      geom_histogram(alpha = 0.7, aes(y = ..density..), position = &#39;identity&#39;) + 
      theme_bw() + 
      scale_fill_viridis_d(begin = 1, end = 0)+
      ggtitle(&quot;Distribution of Sweetness in the Selection&quot;) + 
      labs(y = &quot;Count&quot;)
  })
}

shinyApp(ui = ui, server = server)</code></pre>
<pre><code>## 
## Listening on http://127.0.0.1:5169</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="/post/2020-08-28-d3-charts_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
